(function(c){var b=false;(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-base64",function(){return e()})}else{d.Base64=e()}}(this,function(){var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var e={encode:function(h){var f="";var p,n,l;var o,m,k,j;var g=0;do{p=h.charCodeAt(g++);n=h.charCodeAt(g++);l=h.charCodeAt(g++);o=p>>2;m=((p&3)<<4)|(n>>4);k=((n&15)<<2)|(l>>6);j=l&63;if(isNaN(n)){m=((p&3)<<4);k=j=64}else{if(isNaN(l)){j=64}}f=f+d.charAt(o)+d.charAt(m)+d.charAt(k)+d.charAt(j)}while(g<h.length);return f},decode:function(h){var f="";var p,n,l;var o,m,k,j;var g=0;h=h.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{o=d.indexOf(h.charAt(g++));m=d.indexOf(h.charAt(g++));k=d.indexOf(h.charAt(g++));j=d.indexOf(h.charAt(g++));p=(o<<2)|(m>>4);n=((m&15)<<4)|(k>>2);l=((k&3)<<6)|j;f=f+String.fromCharCode(p);if(k!=64){f=f+String.fromCharCode(n)}if(j!=64){f=f+String.fromCharCode(l)}}while(g<h.length);return f}};return e}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-sha1",function(){return e()})}else{d.SHA1=e()}}(this,function(){function f(C,u){C[u>>5]|=128<<(24-u%32);C[((u+64>>9)<<4)+15]=u;var D=new Array(80);var B=1732584193;var A=-271733879;var z=-1732584194;var y=271733878;var v=-1009589776;var q,o,E,s,r,p,n,m;for(q=0;q<C.length;q+=16){s=B;r=A;p=z;n=y;m=v;for(o=0;o<80;o++){if(o<16){D[o]=C[q+o]}else{D[o]=h(D[o-3]^D[o-8]^D[o-14]^D[o-16],1)}E=i(i(h(B,5),d(o,A,z,y)),i(i(v,D[o]),g(o)));v=y;y=z;z=h(A,30);A=B;B=E}B=i(B,s);A=i(A,r);z=i(z,p);y=i(y,n);v=i(v,m)}return[B,A,z,y,v]}function d(n,m,p,o){if(n<20){return(m&p)|((~m)&o)}if(n<40){return m^p^o}if(n<60){return(m&p)|(m&o)|(p&o)}return m^p^o}function g(m){return(m<20)?1518500249:(m<40)?1859775393:(m<60)?-1894007588:-899497514}function l(o,r){var q=j(o);if(q.length>16){q=f(q,o.length*8)}var m=new Array(16),p=new Array(16);for(var n=0;n<16;n++){m[n]=q[n]^909522486;p[n]=q[n]^1549556828}var s=f(m.concat(j(r)),512+r.length*8);return f(p.concat(s),512+160)}function i(m,p){var o=(m&65535)+(p&65535);var n=(m>>16)+(p>>16)+(o>>16);return(n<<16)|(o&65535)}function h(m,n){return(m<<n)|(m>>>(32-n))}function j(p){var o=[];var m=255;for(var n=0;n<p.length*8;n+=8){o[n>>5]|=(p.charCodeAt(n/8)&m)<<(24-n%32)}return o}function e(o){var p="";var m=255;for(var n=0;n<o.length*32;n+=8){p+=String.fromCharCode((o[n>>5]>>>(24-n%32))&m)}return p}function k(p){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var r="";var q,m;for(var n=0;n<p.length*4;n+=3){q=(((p[n>>2]>>8*(3-n%4))&255)<<16)|(((p[n+1>>2]>>8*(3-(n+1)%4))&255)<<8)|((p[n+2>>2]>>8*(3-(n+2)%4))&255);for(m=0;m<4;m++){if(n*8+m*6>p.length*32){r+="="}else{r+=o.charAt((q>>6*(3-m))&63)}}}return r}return{b64_hmac_sha1:function(m,n){return k(l(m,n))},b64_sha1:function(m){return k(f(j(m),m.length*8))},binb2str:e,core_hmac_sha1:l,str_hmac_sha1:function(m,n){return e(l(m,n))},str_sha1:function(m){return e(f(j(m),m.length*8))},}}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-md5",function(){return e()})}else{d.MD5=e()}}(this,function(m){var k=function(q,t){var s=(q&65535)+(t&65535);var r=(q>>16)+(t>>16)+(s>>16);return(r<<16)|(s&65535)};var o=function(q,r){return(q<<r)|(q>>>(32-r))};var d=function(s){var r=[];for(var q=0;q<s.length*8;q+=8){r[q>>5]|=(s.charCodeAt(q/8)&255)<<(q%32)}return r};var h=function(r){var s="";for(var q=0;q<r.length*32;q+=8){s+=String.fromCharCode((r[q>>5]>>>(q%32))&255)}return s};var p=function(s){var r="0123456789abcdef";var t="";for(var q=0;q<s.length*4;q++){t+=r.charAt((s[q>>2]>>((q%4)*8+4))&15)+r.charAt((s[q>>2]>>((q%4)*8))&15)}return t};var f=function(z,v,u,r,y,w){return k(o(k(k(v,z),k(r,w)),y),u)};var l=function(u,r,z,y,q,w,v){return f((r&z)|((~r)&y),u,r,q,w,v)};var e=function(u,r,z,y,q,w,v){return f((r&y)|(z&(~y)),u,r,q,w,v)};var n=function(u,r,z,y,q,w,v){return f(r^z^y,u,r,q,w,v)};var j=function(u,r,z,y,q,w,v){return f(z^(r|(~y)),u,r,q,w,v)};var g=function(B,v){B[v>>5]|=128<<((v)%32);B[(((v+64)>>>9)<<4)+14]=v;var A=1732584193;var z=-271733879;var y=-1732584194;var w=271733878;var u,t,s,q;for(var r=0;r<B.length;r+=16){u=A;t=z;s=y;q=w;A=l(A,z,y,w,B[r+0],7,-680876936);w=l(w,A,z,y,B[r+1],12,-389564586);y=l(y,w,A,z,B[r+2],17,606105819);z=l(z,y,w,A,B[r+3],22,-1044525330);A=l(A,z,y,w,B[r+4],7,-176418897);w=l(w,A,z,y,B[r+5],12,1200080426);y=l(y,w,A,z,B[r+6],17,-1473231341);z=l(z,y,w,A,B[r+7],22,-45705983);A=l(A,z,y,w,B[r+8],7,1770035416);w=l(w,A,z,y,B[r+9],12,-1958414417);y=l(y,w,A,z,B[r+10],17,-42063);z=l(z,y,w,A,B[r+11],22,-1990404162);A=l(A,z,y,w,B[r+12],7,1804603682);w=l(w,A,z,y,B[r+13],12,-40341101);y=l(y,w,A,z,B[r+14],17,-1502002290);z=l(z,y,w,A,B[r+15],22,1236535329);A=e(A,z,y,w,B[r+1],5,-165796510);w=e(w,A,z,y,B[r+6],9,-1069501632);y=e(y,w,A,z,B[r+11],14,643717713);z=e(z,y,w,A,B[r+0],20,-373897302);A=e(A,z,y,w,B[r+5],5,-701558691);w=e(w,A,z,y,B[r+10],9,38016083);y=e(y,w,A,z,B[r+15],14,-660478335);z=e(z,y,w,A,B[r+4],20,-405537848);A=e(A,z,y,w,B[r+9],5,568446438);w=e(w,A,z,y,B[r+14],9,-1019803690);y=e(y,w,A,z,B[r+3],14,-187363961);z=e(z,y,w,A,B[r+8],20,1163531501);A=e(A,z,y,w,B[r+13],5,-1444681467);w=e(w,A,z,y,B[r+2],9,-51403784);y=e(y,w,A,z,B[r+7],14,1735328473);z=e(z,y,w,A,B[r+12],20,-1926607734);A=n(A,z,y,w,B[r+5],4,-378558);w=n(w,A,z,y,B[r+8],11,-2022574463);y=n(y,w,A,z,B[r+11],16,1839030562);z=n(z,y,w,A,B[r+14],23,-35309556);A=n(A,z,y,w,B[r+1],4,-1530992060);w=n(w,A,z,y,B[r+4],11,1272893353);y=n(y,w,A,z,B[r+7],16,-155497632);z=n(z,y,w,A,B[r+10],23,-1094730640);A=n(A,z,y,w,B[r+13],4,681279174);w=n(w,A,z,y,B[r+0],11,-358537222);y=n(y,w,A,z,B[r+3],16,-722521979);z=n(z,y,w,A,B[r+6],23,76029189);A=n(A,z,y,w,B[r+9],4,-640364487);w=n(w,A,z,y,B[r+12],11,-421815835);y=n(y,w,A,z,B[r+15],16,530742520);z=n(z,y,w,A,B[r+2],23,-995338651);A=j(A,z,y,w,B[r+0],6,-198630844);w=j(w,A,z,y,B[r+7],10,1126891415);y=j(y,w,A,z,B[r+14],15,-1416354905);z=j(z,y,w,A,B[r+5],21,-57434055);A=j(A,z,y,w,B[r+12],6,1700485571);w=j(w,A,z,y,B[r+3],10,-1894986606);y=j(y,w,A,z,B[r+10],15,-1051523);z=j(z,y,w,A,B[r+1],21,-2054922799);A=j(A,z,y,w,B[r+8],6,1873313359);w=j(w,A,z,y,B[r+15],10,-30611744);y=j(y,w,A,z,B[r+6],15,-1560198380);z=j(z,y,w,A,B[r+13],21,1309151649);A=j(A,z,y,w,B[r+4],6,-145523070);w=j(w,A,z,y,B[r+11],10,-1120210379);y=j(y,w,A,z,B[r+2],15,718787259);z=j(z,y,w,A,B[r+9],21,-343485551);A=k(A,u);z=k(z,t);y=k(y,s);w=k(w,q)}return[A,z,y,w]};var i={hexdigest:function(q){return p(g(d(q),q.length*8))},hash:function(q){return h(g(d(q),q.length*8))}};return i}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-utils",function(){return e()})}else{d.stropheUtils=e()}}(this,function(){var d={utf16to8:function(h){var g,j;var f="";var e=h.length;for(g=0;g<e;g++){j=h.charCodeAt(g);if((j>=0)&&(j<=127)){f+=h.charAt(g)}else{if(j>2047){f+=String.fromCharCode(224|((j>>12)&15));f+=String.fromCharCode(128|((j>>6)&63));f+=String.fromCharCode(128|((j>>0)&63))}else{f+=String.fromCharCode(192|((j>>6)&31));f+=String.fromCharCode(128|((j>>0)&63))}}}return f},addCookies:function(h){var l,f,g,k,e,i,j;for(l in (h||{})){e="";i="";j="";f=h[l];g=typeof f=="object";k=escape(unescape(g?f.value:f));if(g){e=f.expires?";expires="+f.expires:"";i=f.domain?";domain="+f.domain:"";j=f.path?";path="+f.path:""}document.cookie=l+"="+k+e+i+j}}};return d}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-polyfill",[],function(){return e()})}else{return e()}}(this,function(){if(!Function.prototype.bind){Function.prototype.bind=function(h){var g=this;var f=Array.prototype.slice;var e=Array.prototype.concat;var d=f.call(arguments,1);return function(){return g.apply(h?h:this,e.call(d,f.call(arguments,0)))}}}if(!Array.isArray){Array.isArray=function(d){return Object.prototype.toString.call(d)==="[object Array]"}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e){var d=this.length;var f=Number(arguments[1])||0;f=(f<0)?Math.ceil(f):Math.floor(f);if(f<0){f+=d}for(;f<d;f++){if(f in this&&this[f]===e){return f}}return -1}}}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils","strophe-polyfill"],function(){return e.apply(this,arguments)})}else{var f=e(d.SHA1,d.Base64,d.MD5,d.stropheUtils);window.Strophe=f.Strophe;window.$build=f.$build;window.$iq=f.$iq;window.$msg=f.$msg;window.$pres=f.$pres;window.SHA1=f.SHA1;window.Base64=f.Base64;window.MD5=f.MD5;window.b64_hmac_sha1=f.SHA1.b64_hmac_sha1;window.b64_sha1=f.SHA1.b64_sha1;window.str_hmac_sha1=f.SHA1.str_hmac_sha1;window.str_sha1=f.SHA1.str_sha1}}(this,function(d,h,i,k){var g;function j(n,m){return new g.Builder(n,m)}function l(m){return new g.Builder("message",m)}function f(m){return new g.Builder("iq",m)}function e(m){return new g.Builder("presence",m)}g={VERSION:"1.2.8",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{"a":["href"],"blockquote":["style"],"br":[],"cite":["style"],"em":[],"img":["src","alt","style","height","width"],"li":["style"],"ol":["style"],"p":["style"],"span":["style"],"strong":[],"ul":["style"],"body":[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(m){for(var n=0;n<g.XHTML.tags.length;n++){if(m==g.XHTML.tags[n]){return true}}return false},validAttribute:function(m,o){if(typeof g.XHTML.attributes[m]!=="undefined"&&g.XHTML.attributes[m].length>0){for(var n=0;n<g.XHTML.attributes[m].length;n++){if(o==g.XHTML.attributes[m][n]){return true}}}return false},validCSS:function(n){for(var m=0;m<g.XHTML.css.length;m++){if(n==g.XHTML.css[m]){return true}}return false}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(m,n){g.NS[m]=n},forEachChild:function(p,q,o){var n,m;for(n=0;n<p.childNodes.length;n++){m=p.childNodes[n];if(m.nodeType==g.ElementType.NORMAL&&(!q||this.isTagEqual(m,q))){o(m)}}},isTagEqual:function(n,m){return n.tagName==m},_xmlGenerator:null,_makeGenerator:function(){var m;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){m=this._getIEXmlDom();m.appendChild(m.createElement("strophe"))}else{m=document.implementation.createDocument("jabber:client","strophe",null)}return m},xmlGenerator:function(){if(!g._xmlGenerator){g._xmlGenerator=g._makeGenerator()}return g._xmlGenerator},_getIEXmlDom:function(){var n=null;var p=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var o=0;o<p.length;o++){if(n===null){try{n=new ActiveXObject(p[o])}catch(m){n=null}}else{break}}return n},xmlElement:function(q){if(!q){return null}var s=g.xmlGenerator().createElement(q);var o,r,p;for(o=1;o<arguments.length;o++){var n=arguments[o];if(!n){continue}if(typeof(n)=="string"||typeof(n)=="number"){s.appendChild(g.xmlTextNode(n))}else{if(typeof(n)=="object"&&typeof(n.sort)=="function"){for(r=0;r<n.length;r++){var m=n[r];if(typeof(m)=="object"&&typeof(m.sort)=="function"&&m[1]!==undefined&&m[1]!==null){s.setAttribute(m[0],m[1])}}}else{if(typeof(n)=="object"){for(p in n){if(n.hasOwnProperty(p)){if(n[p]!==undefined&&n[p]!==null){s.setAttribute(p,n[p])}}}}}}}return s},xmlescape:function(m){m=m.replace(/\&/g,"&amp;");m=m.replace(/</g,"&lt;");m=m.replace(/>/g,"&gt;");m=m.replace(/'/g,"&apos;");m=m.replace(/"/g,"&quot;");return m},xmlunescape:function(m){m=m.replace(/\&amp;/g,"&");m=m.replace(/&lt;/g,"<");m=m.replace(/&gt;/g,">");m=m.replace(/&apos;/g,"'");m=m.replace(/&quot;/g,'"');return m},xmlTextNode:function(m){return g.xmlGenerator().createTextNode(m)},xmlHtmlNode:function(m){var n;if(window.DOMParser){var o=new DOMParser();n=o.parseFromString(m,"text/xml")}else{n=new ActiveXObject("Microsoft.XMLDOM");n.async="false";n.loadXML(m)}return n},getText:function(n){if(!n){return null}var o="";if(n.childNodes.length===0&&n.nodeType==g.ElementType.TEXT){o+=n.nodeValue}for(var m=0;m<n.childNodes.length;m++){if(n.childNodes[m].nodeType==g.ElementType.TEXT){o+=n.childNodes[m].nodeValue}}return g.xmlescape(o)},copyElement:function(o){var m,n;if(o.nodeType==g.ElementType.NORMAL){n=g.xmlElement(o.tagName);for(m=0;m<o.attributes.length;m++){n.setAttribute(o.attributes[m].nodeName,o.attributes[m].value)}for(m=0;m<o.childNodes.length;m++){n.appendChild(g.copyElement(o.childNodes[m]))}}else{if(o.nodeType==g.ElementType.TEXT){n=g.xmlGenerator().createTextNode(o.nodeValue)}}return n},createHtml:function(o){var r,n,p,y,m,x,t,u,w,q,s;if(o.nodeType==g.ElementType.NORMAL){y=o.nodeName.toLowerCase();if(g.XHTML.validTag(y)){try{n=g.xmlElement(y);for(r=0;r<g.XHTML.attributes[y].length;r++){m=g.XHTML.attributes[y][r];x=o.getAttribute(m);if(typeof x=="undefined"||x===null||x===""||x===false||x===0){continue}if(m=="style"&&typeof x=="object"){if(typeof x.cssText!="undefined"){x=x.cssText}}if(m=="style"){t=[];u=x.split(";");for(p=0;p<u.length;p++){w=u[p].split(":");q=w[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(g.XHTML.validCSS(q)){s=w[1].replace(/^\s*/,"").replace(/\s*$/,"");t.push(q+": "+s)}}if(t.length>0){x=t.join("; ");n.setAttribute(m,x)}}else{n.setAttribute(m,x)}}for(r=0;r<o.childNodes.length;r++){n.appendChild(g.createHtml(o.childNodes[r]))}}catch(v){n=g.xmlTextNode("")}}else{n=g.xmlGenerator().createDocumentFragment();for(r=0;r<o.childNodes.length;r++){n.appendChild(g.createHtml(o.childNodes[r]))}}}else{if(o.nodeType==g.ElementType.FRAGMENT){n=g.xmlGenerator().createDocumentFragment();for(r=0;r<o.childNodes.length;r++){n.appendChild(g.createHtml(o.childNodes[r]))}}else{if(o.nodeType==g.ElementType.TEXT){n=g.xmlTextNode(o.nodeValue)}}}return n},escapeNode:function(m){if(typeof m!=="string"){return m}return m.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(m){if(typeof m!=="string"){return m}return m.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(m){if(m.indexOf("@")<0){return null}return m.split("@")[0]},getDomainFromJid:function(m){var n=g.getBareJidFromJid(m);if(n.indexOf("@")<0){return n}else{var o=n.split("@");o.splice(0,1);return o.join("@")}},getResourceFromJid:function(m){var n=m.split("/");if(n.length<2){return null}n.splice(0,1);return n.join("/")},getBareJidFromJid:function(m){return m?m.split("/")[0]:null},log:function(n,m){return},debug:function(m){this.log(this.LogLevel.DEBUG,m)},info:function(m){this.log(this.LogLevel.INFO,m)},warn:function(m){this.log(this.LogLevel.WARN,m)},error:function(m){this.log(this.LogLevel.ERROR,m)},fatal:function(m){this.log(this.LogLevel.FATAL,m)},serialize:function(o){var m;if(!o){return null}if(typeof(o.tree)==="function"){o=o.tree()}var q=o.nodeName;var n,p;if(o.getAttribute("_realname")){q=o.getAttribute("_realname")}m="<"+q;for(n=0;n<o.attributes.length;n++){if(o.attributes[n].nodeName!="_realname"){m+=" "+o.attributes[n].nodeName+"='"+g.xmlescape(o.attributes[n].value)+"'"}}if(o.childNodes.length>0){m+=">";for(n=0;n<o.childNodes.length;n++){p=o.childNodes[n];switch(p.nodeType){case g.ElementType.NORMAL:m+=g.serialize(p);break;case g.ElementType.TEXT:m+=g.xmlescape(p.nodeValue);break;case g.ElementType.CDATA:m+="<![CDATA["+p.nodeValue+"]]>"}}m+="</"+q+">"}else{m+="/>"}return m},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(m,n){g._connectionPlugins[m]=n}};g.Builder=function(n,m){if(n=="presence"||n=="message"||n=="iq"){if(m&&!m.xmlns){m.xmlns=g.NS.CLIENT}else{if(!m){m={xmlns:g.NS.CLIENT}}}}this.nodeTree=g.xmlElement(n,m);this.node=this.nodeTree};g.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return g.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(n){for(var m in n){if(n.hasOwnProperty(m)){if(n[m]===undefined){this.node.removeAttribute(m)}else{this.node.setAttribute(m,n[m])}}}return this},c:function(n,m,o){var p=g.xmlElement(n,m,o);this.node.appendChild(p);if(typeof o!=="string"&&typeof o!=="number"){this.node=p}return this},cnode:function(o){var n;var q=g.xmlGenerator();try{n=(q.importNode!==undefined)}catch(p){n=false}var m=n?q.importNode(o,true):g.copyElement(o);this.node.appendChild(m);this.node=m;return this},t:function(m){var n=g.xmlTextNode(m);this.node.appendChild(n);return this},h:function(n){var m=document.createElement("body");m.innerHTML=n;var o=g.createHtml(m);while(o.childNodes.length>0){this.node.appendChild(o.childNodes[0])}return this}};g.Handler=function(q,p,n,o,s,r,m){this.handler=q;this.ns=p;this.name=n;this.type=o;this.id=s;this.options=m||{matchBare:false};if(!this.options.matchBare){this.options.matchBare=false}if(this.options.matchBare){this.from=r?g.getBareJidFromJid(r):null}else{this.from=r}this.user=true};g.Handler.prototype={isMatch:function(o){var q;var p=null;if(this.options.matchBare){p=g.getBareJidFromJid(o.getAttribute("from"))}else{p=o.getAttribute("from")}q=false;if(!this.ns){q=true}else{var n=this;g.forEachChild(o,null,function(r){if(r.getAttribute("xmlns")==n.ns){q=true}});q=q||o.getAttribute("xmlns")==this.ns}var m=o.getAttribute("type");if(q&&(!this.name||g.isTagEqual(o,this.name))&&(!this.type||(Array.isArray(this.type)?this.type.indexOf(m)!=-1:m==this.type))&&(!this.id||o.getAttribute("id")==this.id)&&(!this.from||p==this.from)){return true}return false},run:function(n){var m=null;try{m=this.handler(n)}catch(o){console.log("Strophe runing callbacks error: ",o.message);if(o.sourceURL){g.fatal("error: "+this.handler+" "+o.sourceURL+":"+o.line+" - "+o.name+": "+o.message)}else{if(o.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",o,o.message)}g.fatal("error: "+this.handler+" "+o.fileName+":"+o.lineNumber+" - "+o.name+": "+o.message)}else{g.fatal("error: "+o.message+"\n"+o.stack)}}throw o}return m},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};g.TimedHandler=function(n,m){this.period=n;this.handler=m;this.lastCalled=new Date().getTime();this.user=true};g.TimedHandler.prototype={run:function(){this.lastCalled=new Date().getTime();return this.handler()},reset:function(){this.lastCalled=new Date().getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};g.Connection=function(m,o){this.service=m;this.options=o||{};var r=this.options.protocol||"";if(m.indexOf("ws:")===0||m.indexOf("wss:")===0||r.indexOf("ws")===0){this._proto=new g.Websocket(this)}else{this._proto=new g.Bosh(this)}this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.authenticated=false;this.connected=false;this.disconnecting=false;this.do_authentication=true;this.paused=false;this.restored=false;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100);k.addCookies(this.options.cookies);for(var n in g._connectionPlugins){if(g._connectionPlugins.hasOwnProperty(n)){var q=g._connectionPlugins[n];var p=function(){};p.prototype=q;this[n]=new p();this[n].init(this)}}};g.Connection.prototype={reset:function(){this._proto._reset();this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.connected=false;this.disconnecting=false;this.restored=false;this._data=[];this._requests=[];this._uniqueId=0},pause:function(){this.paused=true},setJid:function(m){this.jid=m;this.authzid=g.getBareJidFromJid(this.jid);this.authcid=g.getNodeFromJid(this.jid)},getJid:function(){return this.jid},resume:function(){this.paused=false},getUniqueId:function(n){var m="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(q){var p=Math.random()*16|0,o=q=="x"?p:p&3|8;return o.toString(16)});if(typeof(n)=="string"||typeof(n)=="number"){return m+":"+n}else{return m+""}},connect:function(o,p,s,r,q,m,n){this.jid=o;this.authzid=g.getBareJidFromJid(this.jid);this.authcid=n||g.getNodeFromJid(this.jid);this.pass=p;this.servtype="xmpp";this.connect_callback=s;this.disconnecting=false;this.connected=false;this.authenticated=false;this.restored=false;this.domain=g.getDomainFromJid(this.jid);this._changeConnectStatus(g.Status.CONNECTING,null);this._proto._connect(r,q,m)},attach:function(o,m,p,s,r,q,n){if(this._proto instanceof g.Bosh){this._proto._attach(o,m,p,s,r,q,n)}else{throw {name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'}}},restore:function(n,q,p,o,m){if(this._sessionCachingSupported()){this._proto._restore(n,q,p,o,m)}else{throw {name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'}}},_sessionCachingSupported:function(){if(this._proto instanceof g.Bosh){if(!JSON){return false}try{window.sessionStorage.setItem("_strophe_","_strophe_");window.sessionStorage.removeItem("_strophe_")}catch(m){return false}return true}return false},xmlInput:function(m){return},xmlOutput:function(m){return},rawInput:function(m){return},rawOutput:function(m){return},nextValidRid:function(m){return},send:function(n){if(n===null){return}if(typeof(n.sort)==="function"){for(var m=0;m<n.length;m++){this._queueData(n[m])}}else{if(typeof(n.tree)==="function"){this._queueData(n.tree())}else{this._queueData(n)}}this._proto._send()},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(n,t,o,r){var v=null;var q=this;if(typeof(n.tree)==="function"){n=n.tree()}var m=n.getAttribute("id");if(!m){m=this.getUniqueId("sendIQ");n.setAttribute("id",m)}var p=n.getAttribute("to");var s=this.jid;var u=this.addHandler(function(y){if(v){q.deleteTimedHandler(v)}var w=false;var z=y.getAttribute("from");if(z===p||(!p&&(z===g.getBareJidFromJid(s)||z===g.getDomainFromJid(s)||z===s))){w=true}if(!w){throw {name:"StropheError",message:"Got answer to IQ from wrong jid:"+z+"\nExpected jid: "+p}}var x=y.getAttribute("type");if(x=="result"){if(t){t(y)}}else{if(x=="error"){if(o){o(y)}}else{throw {name:"StropheError",message:"Got bad IQ type of "+x}}}},null,"iq",["error","result"],m);if(r){v=this.addTimedHandler(r,function(){q.deleteHandler(u);if(o){o(null)}return false})}this.send(n);return m},_queueData:function(m){if(m===null||!m.tagName||!m.childNodes){throw {name:"StropheError",message:"Cannot queue non-DOMElement."}}this._data.push(m)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(o,n){var m=new g.TimedHandler(o,n);this.addTimeds.push(m);return m},deleteTimedHandler:function(m){this.removeTimeds.push(m)},addHandler:function(r,q,o,p,t,s,n){var m=new g.Handler(r,q,o,p,t,s,n);this.addHandlers.push(m);return m},deleteHandler:function(m){this.removeHandlers.push(m);var n=this.addHandlers.indexOf(m);if(n>=0){this.addHandlers.splice(n,1)}},disconnect:function(m){this._changeConnectStatus(g.Status.DISCONNECTING,m);g.info("Disconnect was called because: "+m);if(this.connected){var n=false;this.disconnecting=true;if(this.authenticated){n=e({xmlns:g.NS.CLIENT,type:"unavailable"})}this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.bind(this));this._proto._disconnect(n)}else{g.info("Disconnect was called before Strophe connected to the server");this._proto._abortAllRequests()}},_changeConnectStatus:function(m,r){for(var n in g._connectionPlugins){if(g._connectionPlugins.hasOwnProperty(n)){var p=this[n];if(p.statusChanged){try{p.statusChanged(m,r)}catch(o){g.error(""+n+" plugin caused an exception "+"changing status: "+o)}}}}if(this.connect_callback){try{this.connect_callback(m,r)}catch(q){g.error("User connection callback caused an "+"exception: "+q)}}},_doDisconnect:function(m){if(typeof this._idleTimeout=="number"){clearTimeout(this._idleTimeout)}if(this._disconnectTimeout!==null){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null}g.info("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=false;this.disconnecting=false;this.restored=false;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(g.Status.DISCONNECTED,m);this.connected=false},_dataRecv:function(t,u){g.info("_dataRecv called");var m=this._proto._reqToData(t);if(m===null){return}if(this.xmlInput!==g.Connection.prototype.xmlInput){if(m.nodeName===this._proto.strip&&m.childNodes.length){this.xmlInput(m.childNodes[0])}else{this.xmlInput(m)}}if(this.rawInput!==g.Connection.prototype.rawInput){if(u){this.rawInput(u)}else{this.rawInput(g.serialize(m))}}var p,n;while(this.removeHandlers.length>0){n=this.removeHandlers.pop();p=this.handlers.indexOf(n);if(p>=0){this.handlers.splice(p,1)}}while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop())}if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return}var r=m.getAttribute("type");var s,o;if(r!==null&&r=="terminate"){if(this.disconnecting){return}s=m.getAttribute("condition");o=m.getElementsByTagName("conflict");if(s!==null){if(s=="remote-stream-error"&&o.length>0){s="conflict"}this._changeConnectStatus(g.Status.CONNFAIL,s)}else{this._changeConnectStatus(g.Status.CONNFAIL,"unknown")}this._doDisconnect(s);return}var q=this;g.forEachChild(m,null,function(z){var w,x;x=q.handlers;q.handlers=[];for(w=0;w<x.length;w++){var v=x[w];try{if(v.isMatch(z)&&(q.authenticated||!v.user)){if(v.run(z)){q.handlers.push(v)}}else{q.handlers.push(v)}}catch(y){g.warn("Removing Strophe handlers due to uncaught exception: "+y.message)}}})},mechanisms:{},_connect_cb:function(u,x,v){g.info("_connect_cb was called");this.connected=true;var n;try{n=this._proto._reqToData(u)}catch(s){if(s!="badformat"){throw s}this._changeConnectStatus(g.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(!n){return}if(this.xmlInput!==g.Connection.prototype.xmlInput){if(n.nodeName===this._proto.strip&&n.childNodes.length){this.xmlInput(n.childNodes[0])}else{this.xmlInput(n)}}if(this.rawInput!==g.Connection.prototype.rawInput){if(v){this.rawInput(v)}else{this.rawInput(g.serialize(n))}}var o=this._proto._connect_cb(n);if(o===g.Status.CONNFAIL){return}this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var q;if(n.getElementsByTagNameNS){q=n.getElementsByTagNameNS(g.NS.STREAM,"features").length>0}else{q=n.getElementsByTagName("stream:features").length>0||n.getElementsByTagName("features").length>0}var w=n.getElementsByTagName("mechanism");var m=[];var p,r,t=false;if(!q){this._proto._no_auth_received(x);return}if(w.length>0){for(p=0;p<w.length;p++){r=g.getText(w[p]);if(this.mechanisms[r]){m.push(this.mechanisms[r])}}}this._authentication.legacy_auth=n.getElementsByTagName("auth").length>0;t=this._authentication.legacy_auth||m.length>0;if(!t){this._proto._no_auth_received(x);return}if(this.do_authentication!==false){this.authenticate(m)}},authenticate:function(n){var q;for(q=0;q<n.length-1;++q){var m=q;for(var p=q+1;p<n.length;++p){if(n[p].prototype.priority>n[m].prototype.priority){m=p}}if(m!=q){var s=n[q];n[q]=n[m];n[m]=s}}var r=false;for(q=0;q<n.length;++q){if(!n[q].prototype.test(this)){continue}this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new n[q]();this._sasl_mechanism.onStart(this);var t=j("auth",{xmlns:g.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var o=this._sasl_mechanism.onChallenge(this,null);t.t(h.encode(o))}this.send(t.tree());r=true;break}if(!r){if(g.getNodeFromJid(this.jid)===null){this._changeConnectStatus(g.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect("x-strophe-bad-non-anon-jid")}else{this._changeConnectStatus(g.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send(f({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).tree())}}},_sasl_challenge_cb:function(o){var n=h.decode(g.getText(o));var m=this._sasl_mechanism.onChallenge(this,n);var p=j("response",{xmlns:g.NS.SASL});if(m!==""){p.t(h.encode(m))}this.send(p.tree());return true},_auth1_cb:function(m){var n=f({type:"set",id:"_auth_2"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!g.getResourceFromJid(this.jid)){this.jid=g.getBareJidFromJid(this.jid)+"/strophe"}n.up().c("resource",{}).t(g.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(n.tree());return false},_sasl_success_cb:function(o){if(this._sasl_data["server-signature"]){var m;var r=h.decode(g.getText(o));var q=/([a-z]+)=([^,]+)(,|$)/;var p=r.match(q);if(p[1]=="v"){m=p[2]}if(m!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._sasl_data={};return this._sasl_failure_cb(null)}}g.info("SASL authentication succeeded.");if(this._sasl_mechanism){this._sasl_mechanism.onSuccess()}this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}var n=[];var s=function(t,u){while(t.length){this.deleteHandler(t.pop())}this._sasl_auth1_cb.bind(this)(u);return false};n.push(this._addSysHandler(function(t){s.bind(this)(n,t)}.bind(this),null,"stream:features",null,null));n.push(this._addSysHandler(function(t){s.bind(this)(n,t)}.bind(this),g.NS.STREAM,"features",null,null));this._sendRestart();return false},_sasl_auth1_cb:function(n){this.features=n;var m,p;for(m=0;m<n.childNodes.length;m++){p=n.childNodes[m];if(p.nodeName=="bind"){this.do_bind=true}if(p.nodeName=="session"){this.do_session=true}}if(!this.do_bind){this._changeConnectStatus(g.Status.AUTHFAIL,null);return false}else{this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var o=g.getResourceFromJid(this.jid);if(o){this.send(f({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).c("resource",{}).t(o).tree())}else{this.send(f({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).tree())}}return false},_sasl_bind_cb:function(m){if(m.getAttribute("type")=="error"){g.info("SASL binding failed.");var n=m.getElementsByTagName("conflict"),q;if(n.length>0){q="conflict"}this._changeConnectStatus(g.Status.AUTHFAIL,q);return false}var p=m.getElementsByTagName("bind");var o;if(p.length>0){o=p[0].getElementsByTagName("jid");if(o.length>0){this.jid=g.getText(o[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send(f({type:"set",id:"_session_auth_2"}).c("session",{xmlns:g.NS.SESSION}).tree())}else{this.authenticated=true;this._changeConnectStatus(g.Status.CONNECTED,null)}}}else{g.info("SASL binding failed.");this._changeConnectStatus(g.Status.AUTHFAIL,null);return false}},_sasl_session_cb:function(m){if(m.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(g.Status.CONNECTED,null)}else{if(m.getAttribute("type")=="error"){g.info("Session creation failed.");this._changeConnectStatus(g.Status.AUTHFAIL,null);return false}}return false},_sasl_failure_cb:function(m){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}if(this._sasl_mechanism){this._sasl_mechanism.onFailure()}this._changeConnectStatus(g.Status.AUTHFAIL,null);return false},_auth2_cb:function(m){if(m.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(g.Status.CONNECTED,null)}else{if(m.getAttribute("type")=="error"){this._changeConnectStatus(g.Status.AUTHFAIL,null);this.disconnect("authentication failed")}}return false},_addSysTimedHandler:function(o,n){var m=new g.TimedHandler(o,n);m.user=false;this.addTimeds.push(m);return m},_addSysHandler:function(q,p,n,o,r){var m=new g.Handler(q,p,n,o,r);m.user=false;this.addHandlers.push(m);return m},_onDisconnectTimeout:function(){g.info("_onDisconnectTimeout was called");this._changeConnectStatus(g.Status.CONNTIMEOUT,null);this._proto._onDisconnectTimeout();this._doDisconnect();return false},_onIdle:function(){var n,p,q,o;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop())}while(this.removeTimeds.length>0){p=this.removeTimeds.pop();n=this.timedHandlers.indexOf(p);if(n>=0){this.timedHandlers.splice(n,1)}}var m=new Date().getTime();o=[];for(n=0;n<this.timedHandlers.length;n++){p=this.timedHandlers[n];if(this.authenticated||!p.user){q=p.lastCalled+p.period;if(q-m<=0){if(p.run()){o.push(p)}}else{o.push(p)}}}this.timedHandlers=o;clearTimeout(this._idleTimeout);this._proto._onIdle();if(this.connected){this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)}}};g.SASLMechanism=function(m,o,n){this.name=m;this.isClientFirst=o;this.priority=n};g.SASLMechanism.prototype={test:function(m){return true},onStart:function(m){this._connection=m},onChallenge:function(m,n){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};g.SASLAnonymous=function(){};g.SASLAnonymous.prototype=new g.SASLMechanism("ANONYMOUS",false,10);g.SASLAnonymous.prototype.test=function(m){return m.authcid===null};g.Connection.prototype.mechanisms[g.SASLAnonymous.prototype.name]=g.SASLAnonymous;g.SASLPlain=function(){};g.SASLPlain.prototype=new g.SASLMechanism("PLAIN",true,20);g.SASLPlain.prototype.test=function(m){return m.authcid!==null};g.SASLPlain.prototype.onChallenge=function(n){var m=n.authzid;m=m+"\u0000";m=m+n.authcid;m=m+"\u0000";m=m+n.pass;return k.utf16to8(m)};g.Connection.prototype.mechanisms[g.SASLPlain.prototype.name]=g.SASLPlain;g.SASLSHA1=function(){};g.SASLSHA1.prototype=new g.SASLMechanism("SCRAM-SHA-1",true,40);g.SASLSHA1.prototype.test=function(m){return m.authcid!==null};g.SASLSHA1.prototype.onChallenge=function(n,o,p){var q=p||i.hexdigest(Math.random()*1234567890);var m="n="+k.utf16to8(n.authcid);m+=",r=";m+=q;n._sasl_data.cnonce=q;n._sasl_data["client-first-message-bare"]=m;m="n,,"+m;this.onChallenge=function(A,J){var H,u,E,x,v,C,F,D,r;var s,B,G;var z="c=biws,";var y=A._sasl_data["client-first-message-bare"]+","+J+",";var I=A._sasl_data.cnonce;var w=/([a-z]+)=([^,]+)(,|$)/;while(J.match(w)){var t=J.match(w);J=J.replace(t[0],"");switch(t[1]){case"r":H=t[2];break;case"s":u=t[2];break;case"i":E=t[2];break}}if(H.substr(0,I.length)!==I){A._sasl_data={};return A._sasl_failure_cb()}z+="r="+H;y+=z;u=h.decode(u);u+="\x00\x00\x00\x01";r=k.utf16to8(A.pass);x=C=d.core_hmac_sha1(r,u);for(F=1;F<E;F++){v=d.core_hmac_sha1(r,d.binb2str(C));for(D=0;D<5;D++){x[D]^=v[D]}C=v}x=d.binb2str(x);s=d.core_hmac_sha1(x,"Client Key");B=d.str_hmac_sha1(x,"Server Key");G=d.core_hmac_sha1(d.str_sha1(d.binb2str(s)),y);A._sasl_data["server-signature"]=d.b64_hmac_sha1(B,y);for(D=0;D<5;D++){s[D]^=G[D]}z+=",p="+h.encode(d.binb2str(s));return z}.bind(this);return m};g.Connection.prototype.mechanisms[g.SASLSHA1.prototype.name]=g.SASLSHA1;g.SASLMD5=function(){};g.SASLMD5.prototype=new g.SASLMechanism("DIGEST-MD5",false,30);g.SASLMD5.prototype.test=function(m){return m.authcid!==null};g.SASLMD5.prototype._quote=function(m){return'"'+m.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};g.SASLMD5.prototype.onChallenge=function(n,y,u){var o=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var z=u||i.hexdigest(""+(Math.random()*1234567890));var v="";var A=null;var w="";var m="";var t;while(y.match(o)){t=y.match(o);y=y.replace(t[0],"");t[2]=t[2].replace(/^"(.+)"$/,"$1");switch(t[1]){case"realm":v=t[2];break;case"nonce":w=t[2];break;case"qop":m=t[2];break;case"host":A=t[2];break}}var s=n.servtype+"/"+n.domain;if(A!==null){s=s+"/"+A}var r=k.utf16to8(n.authcid+":"+v+":"+this._connection.pass);var q=i.hash(r)+":"+w+":"+z;var p="AUTHENTICATE:"+s;var x="";x+="charset=utf-8,";x+="username="+this._quote(k.utf16to8(n.authcid))+",";x+="realm="+this._quote(v)+",";x+="nonce="+this._quote(w)+",";x+="nc=00000001,";x+="cnonce="+this._quote(z)+",";x+="digest-uri="+this._quote(s)+",";x+="response="+i.hexdigest(i.hexdigest(q)+":"+w+":00000001:"+z+":auth:"+i.hexdigest(p))+",";x+="qop=auth";this.onChallenge=function(){return""};return x};g.Connection.prototype.mechanisms[g.SASLMD5.prototype.name]=g.SASLMD5;g.SASLOAuthBearer=function(){};g.SASLOAuthBearer.prototype=new g.SASLMechanism("OAUTHBEARER",true,50);g.SASLOAuthBearer.prototype.test=function(m){return m.authcid!==null};g.SASLOAuthBearer.prototype.onChallenge=function(n){var m="n,a=";m=m+n.authzid;m=m+",";m=m+"\u0001";m=m+"auth=Bearer ";m=m+n.pass;m=m+"\u0001";m=m+"\u0001";return k.utf16to8(m)};g.Connection.prototype.mechanisms[g.SASLOAuthBearer.prototype.name]=g.SASLOAuthBearer;g.SASLExternal=function(){};g.SASLExternal.prototype=new g.SASLMechanism("EXTERNAL",true,60);g.SASLExternal.prototype.onChallenge=function(m){return m.authcid===m.authzid?"":m.authzid};g.Connection.prototype.mechanisms[g.SASLExternal.prototype.name]=g.SASLExternal;return{Strophe:g,$build:j,$msg:l,$iq:f,$pres:e,SHA1:d,Base64:h,MD5:i,}}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-bosh",["strophe-core"],function(f){return e(f.Strophe,f.$build)})}else{return e(Strophe,$build)}}(this,function(f,e){f.Request=function(i,h,g,j){this.id=++f._requestId;this.xmlData=i;this.data=f.serialize(i);this.origFunc=h;this.func=h;this.rid=g;this.date=NaN;this.sends=j||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0}var k=new Date();return(k-this.date)/1000};this.timeDead=function(){if(!this.dead){return 0}var k=new Date();return(k-this.dead)/1000};this.xhr=this._newXHR()};f.Request.prototype={getResponse:function(){var g=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){g=this.xhr.responseXML.documentElement;if(g.tagName=="parsererror"){f.error("invalid response received");f.error("responseText: "+this.xhr.responseText);f.error("responseXML: "+f.serialize(this.xhr.responseXML));throw"parsererror"}}else{if(this.xhr.responseText){f.error("invalid response received");f.error("responseText: "+this.xhr.responseText);throw"badformat"}}return g},_newXHR:function(){var g=null;if(window.XMLHttpRequest){g=new XMLHttpRequest();if(g.overrideMimeType){g.overrideMimeType("text/xml; charset=utf-8")}}else{if(window.ActiveXObject){g=new ActiveXObject("Microsoft.XMLHTTP")}}g.onreadystatechange=this.func.bind(null,this);return g}};f.Bosh=function(g){this._conn=g;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this._requests=[]};f.Bosh.prototype={strip:null,_buildBody:function(){var g=e("body",{rid:this.rid++,xmlns:f.NS.HTTPBIND});if(this.sid!==null){g.attrs({sid:this.sid})}if(this._conn.options.keepalive&&this._conn._sessionCachingSupported()){this._cacheSession()}return g},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.errors=0;if(this._conn._sessionCachingSupported()){window.sessionStorage.removeItem("strophe-bosh-session")}this._conn.nextValidRid(this.rid)},_connect:function(k,j,h){this.wait=k||this.wait;this.hold=j||this.hold;this.errors=0;var g=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":f.NS.BOSH});if(h){g.attrs({route:h})}var i=this._conn._connect_cb;this._requests.push(new f.Request(g.tree(),this._onRequestStateChange.bind(this,i.bind(this._conn)),g.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(i,g,j,m,l,k,h){this._conn.jid=i;this.sid=g;this.rid=j;this._conn.connect_callback=m;this._conn.domain=f.getDomainFromJid(this._conn.jid);this._conn.authenticated=true;this._conn.connected=true;this.wait=l||this.wait;this.hold=k||this.hold;this.window=h||this.window;this._conn._changeConnectStatus(f.Status.ATTACHED,null)},_restore:function(h,l,k,j,g){var i=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(typeof i!=="undefined"&&i!==null&&i.rid&&i.sid&&i.jid&&(typeof h==="undefined"||h===null||f.getBareJidFromJid(i.jid)==f.getBareJidFromJid(h))){this._conn.restored=true;this._attach(i.jid,i.sid,i.rid,l,k,j,g)}else{throw {name:"StropheSessionError",message:"_restore: no restoreable session."}}},_cacheSession:function(){if(this._conn.authenticated){if(this._conn.jid&&this.rid&&this.sid){window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({"jid":this._conn.jid,"rid":this.rid,"sid":this.sid}))}}else{window.sessionStorage.removeItem("strophe-bosh-session")}},_connect_cb:function(h){var j=h.getAttribute("type");var i,k;if(j!==null&&j=="terminate"){i=h.getAttribute("condition");f.error("BOSH-Connection failed: "+i);k=h.getElementsByTagName("conflict");if(i!==null){if(i=="remote-stream-error"&&k.length>0){i="conflict"}this._conn._changeConnectStatus(f.Status.CONNFAIL,i)}else{this._conn._changeConnectStatus(f.Status.CONNFAIL,"unknown")}this._conn._doDisconnect(i);return f.Status.CONNFAIL}if(!this.sid){this.sid=h.getAttribute("sid")}var g=h.getAttribute("requests");if(g){this.window=parseInt(g,10)}var m=h.getAttribute("hold");if(m){this.hold=parseInt(m,10)}var l=h.getAttribute("wait");if(l){this.wait=parseInt(l,10)}},_disconnect:function(g){this._sendTerminate(g)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295);if(this._conn._sessionCachingSupported()){window.sessionStorage.removeItem("strophe-bosh-session")}this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return this._requests.length===0},_hitError:function(g){this.errors++;f.warn("request errored, status: "+g+", number of errors: "+this.errors);if(this.errors>4){this._conn._onDisconnectTimeout()}},_no_auth_received:function(h){if(h){h=h.bind(this._conn)}else{h=this._conn._connect_cb.bind(this._conn)}var g=this._buildBody();this._requests.push(new f.Request(g.tree(),this._onRequestStateChange.bind(this,h.bind(this._conn)),g.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function d(){var g;while(this._requests.length>0){g=this._requests.pop();g.abort=true;g.xhr.abort();g.xhr.onreadystatechange=function(){}}},_onIdle:function(){var j=this._conn._data;if(this._conn.authenticated&&this._requests.length===0&&j.length===0&&!this._conn.disconnecting){f.info("no requests during idle cycle, sending "+"blank request");j.push(null)}if(this._conn.paused){return}if(this._requests.length<2&&j.length>0){var g=this._buildBody();for(var h=0;h<j.length;h++){if(j[h]!==null){if(j[h]==="restart"){g.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":f.NS.BOSH})}else{g.cnode(j[h]).up()}}}delete this._conn._data;this._conn._data=[];this._requests.push(new f.Request(g.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),g.tree().getAttribute("rid")));this._throttledRequestHandler()}if(this._requests.length>0){var k=this._requests[0].age();if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(f.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler()}}if(k>Math.floor(f.TIMEOUT*this.wait)){f.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(f.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler()}}},_onRequestStateChange:function(j,i){f.debug("request id "+i.id+"."+i.sends+" state changed to "+i.xhr.readyState);if(i.abort){i.abort=false;return}var h;if(i.xhr.readyState==4){h=0;try{h=i.xhr.status}catch(k){}if(typeof(h)=="undefined"){h=0}if(this.disconnecting){if(h>=400){this._hitError(h);return}}var g=(this._requests[0]==i);var l=(this._requests[1]==i);if((h>0&&h<500)||i.sends>5){this._removeRequest(i);f.debug("request id "+i.id+" should now be removed")}if(h==200){if(l||(g&&this._requests.length>0&&this._requests[0].age()>Math.floor(f.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0)}this._conn.nextValidRid(Number(i.rid)+1);f.debug("request id "+i.id+"."+i.sends+" got 200");j(i);this.errors=0}else{f.error("request id "+i.id+"."+i.sends+" error "+h+" happened");if(h===0||(h>=400&&h<600)||h>=12000){this._hitError(h);if(h>=400&&h<500){this._conn._changeConnectStatus(f.Status.DISCONNECTING,null);this._conn._doDisconnect()}}}if(!((h>0&&h<500)||i.sends>5)){this._throttledRequestHandler()}}},_processRequest:function(j){var t=this;var o=this._requests[j];var s=-1;try{if(o.xhr.readyState==4){s=o.xhr.status}}catch(m){f.error("caught an error in _requests["+j+"], reqStatus: "+s)}if(typeof(s)=="undefined"){s=-1}if(o.sends>this._conn.maxRetries){this._conn._onDisconnectTimeout();return}var h=o.age();var g=(!isNaN(h)&&h>Math.floor(f.TIMEOUT*this.wait));var k=(o.dead!==null&&o.timeDead()>Math.floor(f.SECONDARY_TIMEOUT*this.wait));var q=(o.xhr.readyState==4&&(s<1||s>=500));if(g||k||q){if(k){f.error("Request "+this._requests[j].id+" timed out (secondary), restarting")}o.abort=true;o.xhr.abort();o.xhr.onreadystatechange=function(){};this._requests[j]=new f.Request(o.xmlData,o.origFunc,o.rid,o.sends);o=this._requests[j]}if(o.xhr.readyState===0){f.debug("request id "+o.id+"."+o.sends+" posting");try{var r=this._conn.options.contentType||"text/xml; charset=utf-8";o.xhr.open("POST",this._conn.service,this._conn.options.sync?false:true);o.xhr.setRequestHeader&&o.xhr.setRequestHeader("Content-Type",r);if(this._conn.options.withCredentials){o.xhr.withCredentials=true}}catch(n){f.error("XHR open failed.");if(!this._conn.connected){this._conn._changeConnectStatus(f.Status.CONNFAIL,"bad-service")}this._conn.disconnect();return}var t=this;var p=function(){o.date=new Date();if(t._conn.options.customHeaders){var i=t._conn.options.customHeaders;for(var u in i){if(i.hasOwnProperty(u)){o.xhr.setRequestHeader(u,i[u])}}}window.XDomainRequest&&(o.xhr.readyState=2);o.xhr.send(o.data)};if(o.sends>1){var l=Math.min(Math.floor(f.TIMEOUT*this.wait),Math.pow(o.sends,3))*1000;setTimeout(function(){p()},l)}else{p()}o.sends++;if(this._conn.xmlOutput!==f.Connection.prototype.xmlOutput){if(o.xmlData.nodeName===this.strip&&o.xmlData.childNodes.length){this._conn.xmlOutput(o.xmlData.childNodes[0])}else{this._conn.xmlOutput(o.xmlData)}}if(this._conn.rawOutput!==f.Connection.prototype.rawOutput){this._conn.rawOutput(o.data)}}else{f.debug("_processRequest: "+(j===0?"first":"second")+" request has readyState of "+o.xhr.readyState)}},_removeRequest:function(h){f.debug("removing request");var g;for(g=this._requests.length-1;g>=0;g--){if(h==this._requests[g]){this._requests.splice(g,1)}}h.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(g){var h=this._requests[g];if(h.dead===null){h.dead=new Date()}this._processRequest(g)},_reqToData:function(g){try{return g.getResponse()}catch(h){if(h!="parsererror"){throw h}this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(i){f.info("_sendTerminate was called");var g=this._buildBody().attrs({type:"terminate"});if(i){g.cnode(i.tree())}var h=new f.Request(g.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),g.tree().getAttribute("rid"));this._requests.push(h);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){if(!this._requests){f.debug("_throttledRequestHandler called with "+"undefined requests")}else{f.debug("_throttledRequestHandler called with "+this._requests.length+" requests")}if(!this._requests||this._requests.length===0){return}if(this._requests.length>0){this._processRequest(0)}if(this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window){this._processRequest(1)}}};return f}));(function(d,e){if(typeof define==="function"&&define.amd&&b){define("strophe-websocket",["strophe-core"],function(f){return e(f.Strophe,f.$build)})}else{return e(Strophe,$build)}}(this,function(e,d){e.Websocket=function(h){this._conn=h;this.strip="wrapper";var f=h.service;if(f.indexOf("ws:")!==0&&f.indexOf("wss:")!==0){var g="";if(h.options.protocol==="ws"&&window.location.protocol!=="https:"){g+="ws"}else{g+="wss"}g+="://"+window.location.host;if(f.indexOf("/")!==0){g+=window.location.pathname+f}else{g+=f}h.service=g}};e.Websocket.prototype={_buildStream:function(){return d("open",{"xmlns":e.NS.FRAMING,"to":this._conn.domain,"version":"1.0"})},_check_streamerror:function(f,l){var o;if(f.getElementsByTagNameNS){o=f.getElementsByTagNameNS(e.NS.STREAM,"error")}else{o=f.getElementsByTagName("stream:error")}if(o.length===0){return false}var m=o[0];var g="";var p="";var n="urn:ietf:params:xml:ns:xmpp-streams";for(var j=0;j<m.childNodes.length;j++){var k=m.childNodes[j];if(k.getAttribute("xmlns")!==n){break}if(k.nodeName==="text"){p=k.textContent}else{g=k.nodeName}}var h="WebSocket stream error: ";if(g){h+=g}else{h+="unknown"}if(p){h+=" - "+g}e.error(h);this._conn._changeConnectStatus(l,g);this._conn._doDisconnect();return true},_reset:function(){return},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(g){var f=this._check_streamerror(g,e.Status.CONNFAIL);if(f){return e.Status.CONNFAIL}},_handleStreamStart:function(i){var g=false;var h=i.getAttribute("xmlns");if(typeof h!=="string"){g="Missing xmlns in <open />"}else{if(h!==e.NS.FRAMING){g="Wrong xmlns in <open />: "+h}}var f=i.getAttribute("version");if(typeof f!=="string"){g="Missing version in <open />"}else{if(f!=="1.0"){g="Wrong version in <open />: "+f}}if(g){this._conn._changeConnectStatus(e.Status.CONNFAIL,g);this._conn._doDisconnect();return false}return true},_connect_cb_wrapper:function(j){if(j.data.indexOf("<open ")===0||j.data.indexOf("<?xml")===0){var k=j.data.replace(/^(<\?.*?\?>\s*)*/,"");if(k===""){return}var h=new DOMParser().parseFromString(k,"text/xml").documentElement;this._conn.xmlInput(h);this._conn.rawInput(j.data);if(this._handleStreamStart(h)){this._connect_cb(h)}}else{if(j.data.indexOf("<close ")===0){this._conn.rawInput(j.data);this._conn.xmlInput(j);var f=j.getAttribute("see-other-uri");if(f){this._conn._changeConnectStatus(e.Status.REDIRECT,"Received see-other-uri, resetting connection");this._conn.reset();this._conn.service=f;this._connect()}else{this._conn._changeConnectStatus(e.Status.CONNFAIL,"Received closing stream");this._conn._doDisconnect()}}else{var g=this._streamWrap(j.data);var i=new DOMParser().parseFromString(g,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this);this._conn._connect_cb(i,null,j.data)}}},_disconnect:function(i){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){if(i){this._conn.send(i)}var h=d("close",{"xmlns":e.NS.FRAMING});this._conn.xmlOutput(h);var f=e.serialize(h);this._conn.rawOutput(f);try{this.socket.send(f)}catch(g){e.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){e.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(f){return"<wrapper>"+f+"</wrapper>"},_closeSocket:function(){if(this.socket){try{this.socket.close()}catch(f){}}this.socket=null},_emptyQueue:function(){return true},_onClose:function(){if(this._conn.connected&&!this._conn.disconnecting){e.error("Websocket closed unexpectedly");this._conn._doDisconnect()}else{e.info("Websocket closed")}},_no_auth_received:function(f){e.error("Server did not send any auth methods");this._conn._changeConnectStatus(e.Status.CONNFAIL,"Server did not send any auth methods");if(f){f=f.bind(this._conn);f()}this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(f){e.error("Websocket error "+f);this._conn._changeConnectStatus(e.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()},_onIdle:function(){var g=this._conn._data;if(g.length>0&&!this._conn.paused){for(var f=0;f<g.length;f++){if(g[f]!==null){var h,j;if(g[f]==="restart"){h=this._buildStream().tree()}else{h=g[f]}j=e.serialize(h);this._conn.xmlOutput(h);this._conn.rawOutput(j);this.socket.send(j)}}this._conn._data=[]}},_onMessage:function(g){WebIM&&WebIM.config.isDebug&&e.info(WebIM.utils.ts()+"recv:",g.data);var f,h;var i='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(g.data===i){this._conn.rawInput(i);this._conn.xmlInput(g);if(!this._conn.disconnecting){this._conn._doDisconnect()}return}else{if(g.data.search("<open ")===0){f=new DOMParser().parseFromString(g.data,"text/xml").documentElement;if(!this._handleStreamStart(f)){return}}else{h=this._streamWrap(g.data);f=new DOMParser().parseFromString(h,"text/xml").documentElement}}if(this._check_streamerror(f,e.Status.ERROR)){return}if(this._conn.disconnecting&&f.firstChild.nodeName==="presence"&&f.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(f);this._conn.rawInput(e.serialize(f));return}this._conn._dataRecv(f,g.data)},_onOpen:function(){e.info("Websocket open");var g=this._buildStream();this._conn.xmlOutput(g.tree());var f=e.serialize(g);this._conn.rawOutput(f);this.socket.send(f)},_reqToData:function(f){return f},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};return e}));(function(d){if(typeof define==="function"&&define.amd&&b){define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(e){return e})}})(this);if(c){if(typeof define==="function"&&define.amd&&b){var a=c;if(typeof requirejs==="function"){requirejs(["strophe"],function(d){a(d.Strophe,d.$build,d.$msg,d.$iq,d.$pres)})}else{require(["strophe"],function(d){a(d.Strophe,d.$build,d.$msg,d.$iq,d.$pres)})}}else{return c(Strophe,$build,$msg,$iq,$pres)}}})(function(b,e,d,a,c){window.Strophe=b;window.$build=e;window.$msg=d;window.$iq=a;window.$pres=c});
